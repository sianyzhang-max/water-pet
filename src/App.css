import React, { useState, useEffect, useRef } from 'react';
import { Settings, Bell, BellOff, Volume2, VolumeX, RotateCcw, Sparkles, MessageCircleQuestion, X, Loader2, Maximize2, Minimize2, Heart } from 'lucide-react';

// ==========================================
// ğŸ”§ é…ç½®åŒºåŸŸ
// ==========================================
const apiKey = ""; // è¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„ Gemini API Key (å¯é€‰)

// ==========================================
// ğŸ’¬ å†…ç½®é¼“åŠ±è¯­å½• (æ—  API Key æ—¶ä½¿ç”¨)
// ==========================================
const defaultMotivations = [
  "ä¸»äººï¼Œä½ çš„å¤§è„‘æ¸´å•¦ï¼ğŸŒ±",
  "å’•å™œå’•å™œ... æˆ‘æƒ³è¦å–æ°´ï¼",
  "å–æ°´ä¼šè®©çš®è‚¤å˜å¥½å“¦ âœ¨",
  "å³ä½¿æ˜¯ä»™å¥³ä¹Ÿè¦å–æ°´çš„ï¼",
  "ä¸è¦ç­‰åˆ°å£æ¸´æ‰æƒ³èµ·æˆ‘~",
  "è¡¥å……æ°´åˆ†ï¼Œä¸“æ³¨åŠ› +100ï¼",
  "ä½ æ˜¯æœ€æ£’çš„ï¼Œå–å£æ°´ä¼‘æ¯ä¸‹å§ï¼",
  "ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡å“¦ï¼ğŸ’§",
  "æ°´æ˜¯ç”Ÿå‘½ä¹‹æºï¼Œä¹Ÿæ˜¯å¿«ä¹ä¹‹æº~",
  "æ‘¸æ‘¸æˆ‘ï¼Œç„¶åå»å–æ¯æ°´å§ï¼",
  "æˆ‘åœ¨å˜ç˜ª... å¿«æ•‘æ•‘æˆ‘ QAQ",
  "æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸€æ¯æ°´è§£å†³ä¸äº†çš„ï¼"
];

// ==========================================
// ğŸµ éŸ³æ•ˆç³»ç»Ÿ
// ==========================================
const playSound = (type) => {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    osc.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    if (type === 'add') {
      // å’•å˜Ÿå’•å˜Ÿå–æ°´å£°
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(300, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(600, ctx.currentTime + 0.1);
      gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
      osc.start();
      osc.stop(ctx.currentTime + 0.2);
    } else if (type === 'win') {
      // å¼€å¿ƒæ¬¢å‘¼
      osc.type = 'sine';
      osc.frequency.setValueAtTime(500, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.2);
      gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
      gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
      osc.start();
      osc.stop(ctx.currentTime + 0.5);
    } else if (type === 'pop') {
      // æ°”æ³¡å£°
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, ctx.currentTime);
      gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
      osc.start();
      osc.stop(ctx.currentTime + 0.1);
    }
  } catch (e) {
    console.error("Audio play failed", e);
  }
};

// ==========================================
// ğŸ§  Gemini API è°ƒç”¨åŠ©æ‰‹
// ==========================================
const callGemini = async (prompt) => {
  if (!apiKey) {
    throw new Error("No API Key");
  }

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
        }),
      }
    );

    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error?.message || "API è¯·æ±‚å¤±è´¥");
    }
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI æš‚æ—¶åœ¨å‘å‘†...";
  } catch (error) {
    console.error("Gemini Error:", error);
    throw error;
  }
};

// ==========================================
// ğŸ’§ æ°´ç²¾çµç»„ä»¶ (The Desktop Pet)
// ==========================================
const WaterSpirit = ({ percentage, onClick, isHappy, isThinking }) => {
  // æ ¹æ®æ°´é‡å†³å®šé¢œè‰²å’Œè¡¨æƒ…
  const getSpiritColor = () => {
    if (percentage < 30) return "from-pink-300 to-red-200"; // ç¼ºæ°´ï¼šå¯çˆ±çš„æ·¡ç²‰è‰²
    if (percentage < 60) return "from-blue-400 to-blue-300";   // ä¸€èˆ¬ï¼šæµ…è“
    return "from-blue-500 to-cyan-400";                        // å……è¶³ï¼šäº®è“
  };

  const getEyeExpression = () => {
    if (isThinking) return "scale-y-50"; // æ€è€ƒä¸­ï¼šçœ¯çœ¼
    if (percentage < 30) return "rotate-12"; // ç¼ºæ°´ï¼šæ™•æ™•çš„
    if (isHappy) return "scale-x-125 scale-y-50"; // å¼€å¿ƒï¼šç¬‘çœ¼
    return ""; // æ­£å¸¸
  };

  return (
    <div 
      onClick={onClick}
      className={`relative w-40 h-40 transition-all duration-500 cursor-pointer group select-none ${isHappy ? 'animate-bounce-gentle' : 'animate-float'}`}
    >
      {/* èº«ä½“ (Blob) */}
      <div className={`absolute inset-0 rounded-[40%] bg-gradient-to-br ${getSpiritColor()} shadow-lg shadow-blue-200/50 transition-colors duration-1000 animate-blob mix-blend-multiply opacity-90`}></div>
      <div className={`absolute inset-0 rounded-[45%] bg-gradient-to-tl ${getSpiritColor()} opacity-80 animate-blob animation-delay-2000`}></div>
      
      {/* é«˜å…‰ */}
      <div className="absolute top-6 left-8 w-8 h-4 bg-white/40 rounded-full rotate-[-20deg] blur-[2px]"></div>

      {/* è„¸éƒ¨ */}
      <div className="absolute inset-0 flex flex-col items-center justify-center pt-4 pointer-events-none">
        {/* çœ¼ç› */}
        <div className="flex gap-8 mb-2">
          <div className={`w-3 h-3 bg-slate-800 rounded-full transition-transform duration-300 ${getEyeExpression()} animate-blink`}></div>
          <div className={`w-3 h-3 bg-slate-800 rounded-full transition-transform duration-300 ${getEyeExpression()} animate-blink`}></div>
        </div>
        
        {/* å˜´å·´ */}
        <div className="w-4 h-2 mt-1">
           {percentage < 30 ? (
             // éš¾è¿‡çš„å˜´
             <svg viewBox="0 0 20 10" className="w-full h-full stroke-slate-800 fill-none stroke-[3] rotate-180 opacity-60">
               <path d="M2,8 Q10,0 18,8" />
             </svg>
           ) : isHappy ? (
             // å¼€å¿ƒçš„å˜´
             <svg viewBox="0 0 20 10" className="w-full h-full stroke-slate-800 fill-none stroke-[3]">
                <path d="M2,2 Q10,10 18,2" />
             </svg>
           ) : (
             // æ­£å¸¸çš„å˜´
             <div className="w-2 h-2 bg-slate-800/50 rounded-full mx-auto"></div>
           )}
        </div>
        
        {/* è…®çº¢ */}
        {(percentage > 60 || isHappy) && (
          <div className="absolute top-1/2 w-full flex justify-between px-6 mt-2 opacity-40">
            <div className="w-4 h-2 bg-pink-400 rounded-full blur-[2px]"></div>
            <div className="w-4 h-2 bg-pink-400 rounded-full blur-[2px]"></div>
          </div>
        )}
      </div>

      {/* ç‚¹å‡»æç¤º */}
      <div className="absolute -bottom-8 w-full text-center text-xs font-bold text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity">
        ç‚¹æˆ‘å–æ°´ +250ml
      </div>
    </div>
  );
};

export default function App() {
  // åŸºç¡€çŠ¶æ€
  const [waterLevel, setWaterLevel] = useState(0);
  const [goal, setGoal] = useState(2000); 
  const [showConfetti, setShowConfetti] = useState(false);
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [notificationsEnabled, setNotificationsEnabled] = useState(false);
  const [lastDrinkTime, setLastDrinkTime] = useState(Date.now());
  const [showSettings, setShowSettings] = useState(false);
  const [reminderInterval, setReminderInterval] = useState(60); 
  
  // æ¡Œé¢æ¨¡å¼çŠ¶æ€
  const [miniMode, setMiniMode] = useState(false); // é»˜è®¤ä¸ºè¯¦ç»†æ¨¡å¼ï¼Œå¯åˆ‡æ¢ä¸ºæ¡Œå® æ¨¡å¼

  // AI ç›¸å…³çŠ¶æ€
  const [motivationText, setMotivationText] = useState("ä¸»äººï¼Œè®°å¾—å–æ°´å“¦ï¼ğŸŒ±");
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [showAiModal, setShowAiModal] = useState(false);
  const [userFeeling, setUserFeeling] = useState("");
  const [aiAdvice, setAiAdvice] = useState("");
  const [aiAdviceLoading, setAiAdviceLoading] = useState(false);
  const [bubblePopKey, setBubblePopKey] = useState(0); // ç”¨äºè§¦å‘æ°”æ³¡åŠ¨ç”»

  // ------------------------------------------------------------
  // âœ¨ AI / æœ¬åœ°é¼“åŠ±åŠŸèƒ½
  // ------------------------------------------------------------
  const fetchNewMotivation = async () => {
    // è§¦å‘æ°”æ³¡é‡ç»˜åŠ¨ç”»
    setBubblePopKey(prev => prev + 1);
    if (soundEnabled) playSound('pop');

    if (!apiKey) {
      // å¦‚æœæ²¡æœ‰ API Keyï¼Œéšæœºä½¿ç”¨æœ¬åœ°è¯­å½•
      const randomText = defaultMotivations[Math.floor(Math.random() * defaultMotivations.length)];
      setMotivationText(randomText);
      return;
    }
    
    setIsAiLoading(true);
    try {
      const prompt = `ä½ æ˜¯ä¸€ä¸ªå¯çˆ±çš„æ¡Œé¢æ°´ç²¾çµå® ç‰©ã€‚
      ä½ çš„ä¸»äººå¯èƒ½æœ‰ ADHDï¼Œå®¹æ˜“åˆ†å¿ƒã€‚
      è¯·è¯´ä¸€å¥ç®€çŸ­ï¼ˆ15å­—ä»¥å†…ï¼‰çš„è¯æ¥å¼•èµ·ä¸»äººçš„æ³¨æ„ï¼Œè®©ä»–å–å£æ°´ã€‚
      è¯­æ°”è¦è¶…çº§å¯çˆ±ã€æ’’å¨‡ï¼Œæˆ–è€…æ˜¯æœ‰ç‚¹è°ƒçš®ã€‚
      ä¾‹å¦‚ï¼šâ€œä¸»äººä¸»äººï¼Œæˆ‘æ¸´ç˜ªå•¦~â€ æˆ– â€œå’•å™œå’•å™œ...è¯¥å–‚æˆ‘æ°´å•¦ï¼â€
      ç›´æ¥è¿”å›å¥å­ï¼Œä¸è¦å¸¦å¼•å·ã€‚`;
      
      const text = await callGemini(prompt);
      setMotivationText(text);
    } catch (error) {
      // API å¤±è´¥ä¹Ÿå›é€€åˆ°æœ¬åœ°è¯­å½•
      const randomText = defaultMotivations[Math.floor(Math.random() * defaultMotivations.length)];
      setMotivationText(randomText);
    } finally {
      setIsAiLoading(false);
    }
  };

  const analyzeFeeling = async () => {
    if (!userFeeling.trim()) return;
    if (!apiKey) {
      setAiAdvice("è™½ç„¶æ²¡è”ç½‘ï¼Œä½†æŠ±æŠ±ä¸»äººï¼å–å£æ°´ä¼‘æ¯ä¸‹å§~ (éœ€é…ç½® API Key ä½¿ç”¨æ™ºèƒ½åˆ†æ)");
      return;
    }

    setAiAdviceLoading(true);
    setAiAdvice("");
    
    try {
      const prompt = `ä½ æ˜¯ä¸€ä¸ªè´´å¿ƒçš„æ°´ç²¾çµã€‚ä¸»äººç°åœ¨çš„æ„Ÿè§‰æ˜¯ï¼šâ€œ${userFeeling}â€ã€‚
      å¦‚æœæ˜¯èº«ä½“ä¸é€‚ï¼Œæ¸©æŸ”åœ°åˆ¤æ–­æ˜¯å¦éœ€è¦å–æ°´ã€‚
      å¦‚æœæ˜¯æƒ…ç»ªé—®é¢˜ï¼Œç»™ä¸€ä¸ªæš–å¿ƒçš„æ‹¥æŠ±ã€‚
      ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€æ¥å›ç­”ï¼Œè¯­æ°”å¯çˆ±æ²»æ„ˆï¼Œç®€çŸ­ä¸€ç‚¹ï¼ˆ40å­—ä»¥å†…ï¼‰ã€‚`;

      const text = await callGemini(prompt);
      setAiAdvice(text);
      if (soundEnabled) playSound('pop');
    } catch (error) {
      setAiAdvice("æŠ±æŠ±ä¸»äºº... AI æš‚æ—¶è¿ä¸ä¸Šï¼Œä½†æˆ‘åœ¨å‘¢ï¼");
    } finally {
      setAiAdviceLoading(false);
    }
  };

  // ------------------------------------------------------------
  // é€»è¾‘æ§åˆ¶
  // ------------------------------------------------------------
  const requestNotification = () => {
    if (!("Notification" in window)) {
      alert("ä¸æ”¯æŒé€šçŸ¥");
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then((permission) => {
        if (permission === "granted") setNotificationsEnabled(true);
      });
    }
  };

  useEffect(() => {
    if (!notificationsEnabled) return;
    const intervalId = setInterval(() => {
      const now = Date.now();
      if ((now - lastDrinkTime) / 1000 / 60 >= reminderInterval) {
        new Notification("ä¸»äººï¼", { body: "æ°´ç²¾çµå¿«å¹²æ¯å•¦ï¼Œå¿«å–‚æˆ‘å–æ°´ï¼ğŸ’§", icon: "/favicon.ico" });
      }
    }, 60000); 
    return () => clearInterval(intervalId);
  }, [notificationsEnabled, lastDrinkTime, reminderInterval]);

  const addWater = (amount) => {
    const newLevel = Math.min(waterLevel + amount, goal + 1000);
    setWaterLevel(newLevel);
    setLastDrinkTime(Date.now());
    
    if (soundEnabled) playSound('add');
    
    // å–æ°´åä¸ä»…æœ‰æ¦‚ç‡ AI è¯´è¯ï¼Œå¦‚æœæ²¡ API Key ä¹Ÿä¼šè¯´è¯
    fetchNewMotivation();

    if (waterLevel < goal && newLevel >= goal) {
      setShowConfetti(true);
      if (soundEnabled) playSound('win');
      setTimeout(() => setShowConfetti(false), 5000);
    }
  };

  const percentage = Math.min((waterLevel / goal) * 100, 100);

  return (
    <div className="min-h-screen bg-slate-50/50 flex flex-col items-center justify-center font-sans text-slate-800 relative overflow-hidden select-none">
      
      {/* è£…é¥°èƒŒæ™¯ */}
      {!miniMode && (
         <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20">
            <div className="absolute top-10 left-10 w-64 h-64 bg-blue-200 rounded-full blur-3xl mix-blend-multiply animate-blob"></div>
            <div className="absolute bottom-20 right-20 w-64 h-64 bg-indigo-200 rounded-full blur-3xl mix-blend-multiply animate-blob animation-delay-4000"></div>
         </div>
      )}

      {/* ------------------- æ¨¡æ€æ¡†åŒºåŸŸ ------------------- */}
      {showSettings && (
        <div className="absolute inset-0 bg-white/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
          <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-xs border border-slate-100">
            <div className="flex justify-between items-center mb-4">
               <h3 className="text-xl font-bold text-slate-700">è®¾ç½®</h3>
               <button onClick={() => setShowSettings(false)}><X size={20} className="text-slate-400 hover:text-slate-600"/></button>
            </div>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium text-slate-500">æ¯æ—¥ç›®æ ‡ (ml)</label>
                <input type="number" value={goal} onChange={(e) => setGoal(Number(e.target.value))} className="w-full mt-1 p-2 rounded-lg border border-slate-200 bg-slate-50"/>
              </div>
              <div>
                <label className="text-sm font-medium text-slate-500">æé†’é—´éš” (åˆ†é’Ÿ)</label>
                <select value={reminderInterval} onChange={(e) => setReminderInterval(Number(e.target.value))} className="w-full mt-1 p-2 rounded-lg border border-slate-200 bg-slate-50">
                  {[30, 45, 60, 90, 120].map(m => <option key={m} value={m}>{m} åˆ†é’Ÿ</option>)}
                </select>
              </div>
              <div className="flex items-center justify-between pt-2">
                 <span className="text-sm font-medium text-slate-500">å£°éŸ³å¼€å…³</span>
                 <button onClick={() => setSoundEnabled(!soundEnabled)} className={`p-2 rounded-full ${soundEnabled ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-400'}`}>
                   {soundEnabled ? <Volume2 size={18}/> : <VolumeX size={18}/>}
                 </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* âœ¨ AI çŠ¶æ€åˆ†ææ¨¡æ€æ¡† */}
      {showAiModal && (
        <div className="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
          <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-sm border border-blue-100 relative">
            <button onClick={() => setShowAiModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={24} /></button>
            <div className="text-center mb-4">
              <div className="inline-block p-3 bg-indigo-50 rounded-full mb-2"><Sparkles className="text-indigo-500" size={24}/></div>
              <h3 className="text-lg font-bold text-slate-800">æ°´ç²¾çµè¯Šæ‰€</h3>
            </div>
            
            {aiAdvice ? (
               <div className="bg-indigo-50 p-4 rounded-xl mb-4 text-indigo-800 text-sm leading-relaxed animate-fade-in border border-indigo-100">
                 {aiAdvice}
                 <button onClick={() => setAiAdvice("")} className="block w-full mt-2 text-center text-xs text-indigo-400 font-bold hover:text-indigo-600">å†é—®ä¸€æ¬¡</button>
               </div>
            ) : (
              <>
                <textarea 
                  value={userFeeling}
                  onChange={(e) => setUserFeeling(e.target.value)}
                  placeholder="æˆ‘ç°åœ¨æ„Ÿè§‰æœ‰ç‚¹..."
                  className="w-full h-20 p-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-300 mb-4 resize-none text-sm"
                />
                <button 
                  onClick={analyzeFeeling}
                  disabled={aiAdviceLoading || !userFeeling.trim()}
                  className="w-full py-2 bg-indigo-500 text-white rounded-xl font-bold hover:bg-indigo-600 transition-all flex items-center justify-center gap-2 text-sm"
                >
                  {aiAdviceLoading ? <Loader2 className="animate-spin" size={16}/> : "å‘Šè¯‰æ°´ç²¾çµ"}
                </button>
              </>
            )}
          </div>
        </div>
      )}

      {/* ============================================================ */}
      {/* ğŸ–¥ï¸ æ ¸å¿ƒç•Œé¢ (æ¡Œé¢æ¡Œå® ) */}
      {/* ============================================================ */}
      
      <div className={`transition-all duration-500 ease-in-out flex flex-col items-center justify-center ${miniMode ? 'scale-90' : 'scale-100'}`}>
        
        {/* 1. å¯¹è¯æ°”æ³¡åŒºåŸŸ (å¸¦åŠ¨ç”» key) */}
        <div className="relative mb-4 h-16 flex items-end justify-center w-64">
           {/* æ°”æ³¡æœ¬ä½“ */}
           <div 
             key={bubblePopKey} 
             className={`bg-white border-2 border-slate-100 px-4 py-3 rounded-2xl rounded-bl-none shadow-sm relative animate-pop-in transition-all duration-300 origin-bottom-left ${isAiLoading ? 'opacity-80' : 'opacity-100'}`}
           >
              <p className="text-sm font-medium text-slate-600 text-center max-w-[200px] leading-relaxed">
                 {isAiLoading ? "æ€è€ƒä¸­..." : motivationText}
              </p>
              
              {/* è£…é¥°å°æ°”æ³¡åœ†ç‚¹ï¼Œå¢åŠ â€œæ°”æ³¡â€æ„Ÿ */}
              <div className="absolute -left-1 bottom-0 w-1.5 h-1.5 bg-white border border-slate-100 rounded-full"></div>
              <div className="absolute -left-2.5 bottom-[-4px] w-1 h-1 bg-white border border-slate-100 rounded-full"></div>

              {/* åˆ·æ–°æŒ‰é’® (ä»… hover æ˜¾ç¤º) */}
              <button 
                onClick={(e) => {e.stopPropagation(); fetchNewMotivation();}}
                className="absolute -top-2 -right-2 bg-yellow-100 text-yellow-600 rounded-full p-1 opacity-0 hover:opacity-100 transition-opacity shadow-sm"
                title="æ¢ä¸€å¥"
              >
                <Sparkles size={12}/>
              </button>
           </div>
        </div>

        {/* 2. æ°´ç²¾çµæœ¬ä½“ */}
        <WaterSpirit 
           percentage={percentage} 
           isHappy={showConfetti} 
           isThinking={isAiLoading || aiAdviceLoading}
           onClick={() => addWater(250)}
        />

        {/* 3. æç®€æ¨¡å¼ä¸‹çš„è¿›åº¦æ¡ (Mini Mode Only) */}
        {miniMode && (
          <div className="mt-4 flex flex-col items-center gap-2 animate-fade-in">
             <div className="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
                <div className="h-full bg-blue-400 transition-all duration-500" style={{width: `${percentage}%`}}></div>
             </div>
             <div className="flex gap-4 text-slate-400">
                <button onClick={() => setMiniMode(false)} className="hover:text-blue-500"><Maximize2 size={16}/></button>
                <button onClick={() => setWaterLevel(Math.max(0, waterLevel - 250))} className="hover:text-red-500"><RotateCcw size={16}/></button>
             </div>
          </div>
        )}

        {/* 4. å®Œæ•´æ§åˆ¶é¢æ¿ (Full Mode Only) */}
        {!miniMode && (
          <div className="w-full max-w-xs mt-8 animate-fade-in">
            {/* çŠ¶æ€æ•°æ® */}
            <div className="text-center mb-6">
               <h1 className="text-4xl font-black text-slate-800 mb-1">{waterLevel} <span className="text-base font-normal text-slate-500">/ {goal} ml</span></h1>
               <div className="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                 <div className="bg-gradient-to-r from-blue-500 to-cyan-400 h-full transition-all duration-1000 ease-out" style={{ width: `${percentage}%` }}></div>
               </div>
            </div>

            {/* åŠŸèƒ½æŒ‰é’®ç½‘æ ¼ */}
            <div className="grid grid-cols-4 gap-3 mb-4">
               <button onClick={() => setShowAiModal(true)} className="col-span-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-xl py-3 flex items-center justify-center gap-2 transition-colors font-bold text-sm">
                  <Heart size={16} className="fill-current"/> å¿ƒæƒ…åˆ†æ
               </button>
               <button onClick={() => setShowSettings(true)} className="bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl flex items-center justify-center transition-colors">
                  <Settings size={20}/>
               </button>
               <button onClick={() => notificationsEnabled ? setNotificationsEnabled(false) : requestNotification()} className={`rounded-xl flex items-center justify-center transition-colors ${notificationsEnabled ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}`}>
                  {notificationsEnabled ? <Bell size={20}/> : <BellOff size={20}/>}
               </button>
            </div>

            {/* åº•éƒ¨å°æŒ‰é’® */}
            <div className="flex justify-between items-center px-2">
               <button onClick={() => setWaterLevel(Math.max(0, waterLevel - 250))} className="text-xs text-slate-400 hover:text-slate-600 px-2 py-1">æ’¤é”€</button>
               <button onClick={() => setMiniMode(true)} className="flex items-center gap-1 text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors">
                  <Minimize2 size={12}/> å˜èº«æ¡Œå® 
               </button>
               <button onClick={() => {setWaterLevel(0); setLastDrinkTime(Date.now())}} className="text-xs text-slate-400 hover:text-red-500 px-2 py-1">é‡ç½®</button>
            </div>
          </div>
        )}

      </div>

      {/* Confetti Effect */}
      {showConfetti && (
        <div className="fixed inset-0 pointer-events-none z-50 flex items-center justify-center">
          <div className="absolute animate-ping opacity-75 w-96 h-96 bg-yellow-100 rounded-full blur-3xl mix-blend-multiply"></div>
          <div className="text-6xl animate-bounce drop-shadow-lg">ğŸ‰</div>
        </div>
      )}

      {/* CSS åŠ¨ç”»å®šä¹‰ */}
      <style>{`
        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(5px, -10px) scale(1.05); }
          66% { transform: translate(-5px, 5px) scale(0.95); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-8px); }
        }
        @keyframes pop-in {
          0% { transform: scale(0) translateY(10px); opacity: 0; }
          70% { transform: scale(1.1) translateY(-2px); opacity: 1; }
          100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        @keyframes blink {
          0%, 96%, 100% { transform: scaleY(1); }
          98% { transform: scaleY(0.1); }
        }
        @keyframes bounce-gentle {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-15px); }
        }
        .animate-blob { animation: blob 6s infinite; }
        .animate-float { animation: float 4s ease-in-out infinite; }
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-blink { animation: blink 4s infinite; }
        .animate-bounce-gentle { animation: bounce-gentle 1s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      `}</style>
    </div>
  );
}